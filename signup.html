<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SociHub Signup</title>
<style>
  body { font-family: Arial; background:#121212; color:#fff; display:flex; justify-content:center; align-items:center; height:100vh; padding:20px; }
  form { display:flex; flex-direction:column; gap:12px; width:320px; }
  input, button { padding:12px; border-radius:6px; border:none; }
  button { background:#00ffcc; color:#000; font-weight:bold; cursor:pointer; }
  .checkbox-label { font-size:12px; display:flex; align-items:center; gap:5px; }
  .error { color:#ff4444; font-size:12px; display:none; }
  .google-btn { background:#4285F4; color:#fff; font-weight:bold; margin-top:10px; }
</style>
</head>
<body>

<div>
  <h2 id="roleHeading">Sign Up</h2>
  <form id="signupForm">
    <input type="hidden" id="roleInput" name="role" value="">
    <input type="text" id="fullname" name="fullname" placeholder="Full Name" required>
    <input type="text" id="nickname" name="nickname" placeholder="Nickname" required>
    <div class="error" id="nicknameError">Nickname already exists</div>
    <input type="email" id="email" name="email" placeholder="Email" required>
    <input type="password" id="password" name="password" placeholder="Password" required>
    <div class="checkbox-label">
      <input type="checkbox" id="privacyCheck">
      <span>I agree to the <a href="#" style="color:#00ffcc;">Privacy Policy</a></span>
    </div>
    <div class="error" id="privacyError">You must agree to continue</div>
    <button type="submit">Sign Up</button>
  </form>
  <button id="googleSignIn" class="google-btn">Sign Up with Google</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
import { getAuth, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, query, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAK4b3ASYB0USFC6cNQiQ9DA3_ROS48RYI",
  authDomain: "socihub-a2731.firebaseapp.com",
  projectId: "socihub-a2731",
  storageBucket: "socihub-a2731.firebasestorage.app",
  messagingSenderId: "815252223754",
  appId: "1:815252223754:web:99a26383a59c2557412cf3",
  measurementId: "G-KXW58D7RGM"
};

const app = initializeApp(firebaseConfig);
getAnalytics(app);
const auth = getAuth();
const db = getFirestore();

const urlParams = new URLSearchParams(window.location.search);
const role = urlParams.get('role') || 'earner';
document.getElementById('roleHeading').innerText = `Sign Up as ${role.charAt(0).toUpperCase() + role.slice(1)}`;
document.getElementById('roleInput').value = role;

// Email/Password Signup
const signupForm = document.getElementById('signupForm');
signupForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fullname = document.getElementById('fullname').value.trim();
  const nickname = document.getElementById('nickname').value.trim();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const privacyCheck = document.getElementById('privacyCheck').checked;

  if (!privacyCheck) {
    document.getElementById('privacyError').style.display = 'block';
    return;
  } else document.getElementById('privacyError').style.display = 'none';

  try {
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("nickname", "==", nickname));
    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
      document.getElementById('nicknameError').style.display = 'block';
      return;
    } else document.getElementById('nicknameError').style.display = 'none';

    await createUserWithEmailAndPassword(auth, email, password);
    const user = auth.currentUser;
    if (!user) throw new Error("User not authenticated.");

    const uid = user.uid;
    await setDoc(doc(db, "users", uid), {
      fullname,
      nickname,
      email,
      role,
      balance: role === 'earner' ? 100 : 0,
      createdAt: new Date()
    });

    if(role === 'earner') window.location.href = 'earnpage.html';
    else if(role === 'buyer') window.location.href = 'main_buyer.html';
    else if(role === 'admin') window.location.href = 'admin_dashboard.html';

  } catch (error) {
    console.error(error);
    alert("Signup Error: " + error.message);
  }
});

// Google Signup
const googleBtn = document.getElementById('googleSignIn');
googleBtn.addEventListener('click', async () => {
  try {
    const provider = new GoogleAuthProvider();
    const result = await signInWithPopup(auth, provider);
    const user = result.user;

    // Check if Firestore doc exists
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if(!userDoc.exists()) {
      await setDoc(doc(db, "users", user.uid), {
        fullname: user.displayName || "Google User",
        nickname: user.displayName ? user.displayName.replace(/\s+/g,'').toLowerCase() : "googleuser",
        email: user.email,
        role: "earner",
        balance: 100,
        createdAt: new Date()
      });
    }

    window.location.href = 'earnpage.html'; // Google signup default redirect

  } catch(error) {
    console.error(error);
    alert("Google Sign-In Error: " + error.message);
  }
});
</script>
</body>
</html>